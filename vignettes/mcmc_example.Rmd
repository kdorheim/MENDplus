---
title: "MCMC Setup"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Setting Up an MCMC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(MENDplus)
library(mcmc)
```

### Objective: 

In this vignette we walk through the code that is needed to set up the [mcmc](https://cran.r-project.org/web/packages/mcmc/mcmc.pdf) [metrop](https://www.rdocumentation.org/packages/mcmc/versions/0.9-6/topics/metrop) function to to calibrate MENDplus. 

A general over  view of this process is the following 

1. Set up comparison data 
2. Deinfe the log posterior function
3. Run the metropolis algorithm 


### 1. Comparison Data 

As an example we are going to use output from a MEND run as comparison data. Users can use data from observations or other modeling sources as comparison data. But it will need to be a data frame consisiting of a time and IC columns, where IC is the $CO_[2]$. 



```{r}
# Specify the time steps.
times <- seq(0, 1000, 1)

# Define the inital state of the MEND C pools. 
state <- c(P = 10,  M = 5,  Q = 0.1,  B = 2,  D = 1,  EP = 0.00001, 
           EM = 0.00001, IC = 0,  Tot = 18.10002)


# Set up the ODE solver to solve MEND governed with MEND's default flux.
output <- as.data.frame(deSolve::ode(y = state, times = times, parms = default_parameters,   
                                     func = MEND_carbon_pools, flux_function = MEND_fluxes))  

comp <- as.data.frame(output[, names(output) %in% c('time', 'IC')])
```


### 2. Deinfe the log posterior function

The posterior probability to a key part of any Baeysian or MCMC calibration see [here](https://en.wikipedia.org/wiki/Posterior_probability) for more details. The `metrop` function requires

> If a function, it evaluates the log unnormalized probability density of the desired equilibrium distribution of the Markov chain.

We devloped `make_logpost` that returns a function that calculates the log unnormalized probability based the user defined parameters to calibrate and comparison data. 


```{r}
# Select the MEND parameters to calibrate and provide an inital estimate for the values. 
params_to_calibrate <- c('K.p' = 25,'K.m' = 125, 'K.d' = 0.13)

# Use the make_logpost function to create the log posteior function.
log_post <- make_logpost(comp = comp, params = params_to_calibrate)
```


### 3. Run the mcmc!

```{r, message=FALSE,  warning=FALSE}
# Use a random seed generator to ensure reproducible results. 
set.seed('8675309')

# Because this is an example to illustrate how to set  up the mcmc with MENDplus this metrop
# call was not configured to run a complete mcmc. 
out <- metrop(obj = log_post, initial = params_to_calibrate, nbatch = 10) 
```

Take a look at some quick diagnostic plots. 

```{r,  fig.width=6, fig.height=4}
plot(ts(out$batch))
```


```{r,  fig.width=6, fig.height=4}
acf(out$batch)
```
